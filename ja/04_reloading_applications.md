## Day 4: アプリケーションのリロード

昨日はplackupの基本とコマンドラインオプションについて解説しました。今日もつづけましょう！

### 必要に応じてアプリケーションをリロードする

開発中のコードは`.psgi`や`.pm`に書かれたPerlのコードを編集します。plackupによって起動されたサーバは永続プロセスのため、最初に一度だけコンパイルされたPSGIコードが何度も実行されます。コードの変更を反映するにはサーバプロセスを再起動する必要があり、面倒です。

作業ディレクトリ以下のファイルを監視し、変更があったらアプリケーションをリロードするオプションが用意されています。`-r`または`--reload`です。

    plackup -r hello.psgi

デフォルトではカレントディレクトリ以下のファイルをモニターしますが、他のパスを指定するには`-R`(大文字)で指定します。

    plackup -R lib,/path/to/scripts hello.psgi

複数のパスを指定するにはカンマ(,)で区切ります。

デフォルトではタイマーを利用してディレクトリの中身をスキャンしますが、LinuxではLinux::Inotify2, Mac OS Xでは Mac::FSEventsがインストールされている場合、ファイルシステムのイベント通知を利用するため、より効率的です。

### -r とサーバ自動選択

Day 3でplackupのサーバ自動選択について紹介しました。アプリケーションがAnyEvent, CoroやPOEを利用している場合、それに対応したサーバが自動で選択される機能です。この機能は`-r`や`-R`オプションが有効の場合、正常に機能しません。アプリケーションのロードが起動時には行われなくなるためです。リロード機能を使う場合、`-s`で明示的にバックエンドサーバを指定してください。

### リロードがうまく動かない場合: Shotgun

永続環境のperlプロセスでモジュールやアプリケーションを読み直す場合、問題がおこることがあります。モジュールのパッケージ変数を更新したり、初期化する場合です。

PlackにあるShotgunローダーは、Rackの[shotgun](http://github.com/rtomayko/shotgun)にインスパイアされたハンドラで、リクエストごとに子プロセスをforkして、そこでアプリケーションを読み直します。

Shotgunローダーの利用は簡単です。

    > plackup -L Shotgun myapp.psgi

アプリケーションのコンパイルがランタイムまで遅延され、新しいリクエストが来た際、新しい子プロセスをforkし、PSGIのレスポンスをパイプ上で返します。開発中には変更することのないモジュールはプリロードしておき、レスポンスのボトルネックにならないようにすることも可能です。

たとえば、アプリケーションがMooseとDBIx::Classを使っているなら、

    > plackup -MMoose -MDBIx::Class -L Shotgun myapp.psgi

とすればリクエストごとに読み直すコードが減少するため、スピードアップが期待できます。
